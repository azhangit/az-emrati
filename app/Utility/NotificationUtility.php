<?php

namespace App\Utility;

use App\Mail\InvoiceEmailManager;
use App\Models\User;
use App\Models\SmsTemplate;
use App\Http\Controllers\OTPVerificationController;
use Mail;
use Illuminate\Support\Facades\Notification;
use App\Notifications\OrderNotification;
use App\Models\FirebaseNotification;

class NotificationUtility
{
   public static function sendOrderPlacedNotification($order, $request = null)
{       
    $array['view'] = 'emails.invoice';
    $array['subject'] = translate('A new order has been placed') . ' - ' . $order->code;
    $array['from'] = env('MAIL_FROM_ADDRESS');
    $array['order'] = $order;

    try {
        // ğŸŸ¢ Agar login user hai
        if ($order->user && $order->user->email != null) {
            Mail::to($order->user->email)->queue(new InvoiceEmailManager($array));
        }

        // ğŸŸ¢ Seller ko mail
        if ($order->orderDetails->first()->product->user->email ?? false) {
            Mail::to($order->orderDetails->first()->product->user->email)->queue(new InvoiceEmailManager($array));
        }

        // ğŸŸ¢ Guest case me â€” admin ko mail (force send)
        Mail::to('connecttoabdulrehman01@gmail.com')->queue(new InvoiceEmailManager($array));

        // ğŸŸ¢ Agar guest ka email shipping_address JSON me hai
        if (!$order->user && $order->shipping_address) {
            $guest_address = json_decode($order->shipping_address);
            if (!empty($guest_address->email)) {
                Mail::to($guest_address->email)->queue(new InvoiceEmailManager($array));
            }
        }

    } catch (\Exception $e) {
        \Log::error("Order mail failed: " . $e->getMessage());
    }

    // ğŸŸ¢ SMS agar OTP system active hai
    if (addon_is_activated('otp_system') && SmsTemplate::where('identifier', 'order_placement')->first()->status == 1) {
        try {
            $otpController = new OTPVerificationController;
            $otpController->send_order_code($order);
        } catch (\Exception $e) {
            \Log::error("Order SMS failed: " . $e->getMessage());
        }
    }

    // ğŸŸ¢ Notifications
    self::sendNotification($order, 'placed');

    // ğŸŸ¢ Firebase push
    if ($request != null && get_setting('google_firebase') == 1 && $order->user && $order->user->device_token != null) {
        $request->device_token = $order->user->device_token;
        $request->title = "Order placed !";
        $request->text = "An order {$order->code} has been placed";
        $request->type = "order";
        $request->id = $order->id;
        $request->user_id = $order->user->id;

        self::sendFirebaseNotification($request);
    }
}


  public static function sendNotification($order, $order_status)
{
    $admin_id = \App\Models\User::where('user_type', 'admin')->first()->id;

    // Users list banane ke liye array initialize karo
    $user_ids = [];

    // Agar order guest ka hai (user_id null hoga)
    if ($order->user_id != null) {
        $user_ids[] = $order->user_id; // sirf tab add karo jab user exist kare
    }

    // Seller ko hamesha add karo
    $user_ids[] = $order->seller_id;

    // Agar seller admin nahi hai, to admin ko bhi add karo
    if ($order->seller_id != $admin_id) {
        $user_ids[] = $admin_id;
    }

    // Users fetch karo
    $users = User::findMany($user_ids);

    // Notification data
    $order_notification = [
        'order_id'   => $order->id,
        'order_code' => $order->code,
        'user_id'    => $order->user_id,   // guest ke liye null rahega
        'seller_id'  => $order->seller_id,
        'status'     => $order_status,
    ];

    // Send notification
    Notification::send($users, new OrderNotification($order_notification));
}

    public static function sendFirebaseNotification($req)
    {        
        $url = 'https://fcm.googleapis.com/fcm/send';

        $fields = array
        (
            'to' => $req->device_token,
            'notification' => [
                'body' => $req->text,
                'title' => $req->title,
                'sound' => 'default' /*Default sound*/
            ],
            'data' => [
                'item_type' => $req->type,
                'item_type_id' => $req->id,
                'click_action' => 'FLUTTER_NOTIFICATION_CLICK'
            ]
        );

        //$fields = json_encode($arrayToSend);
        $headers = array(
            'Authorization: key=' . env('FCM_SERVER_KEY'),
            'Content-Type: application/json'
        );

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_HTTPHEADER, $headers);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);
        curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, false);
        curl_setopt($ch, CURLOPT_POSTFIELDS, json_encode($fields));

        $result = curl_exec($ch);
        curl_close($ch);

        $firebase_notification = new FirebaseNotification;
        $firebase_notification->title = $req->title;
        $firebase_notification->text = $req->text;
        $firebase_notification->item_type = $req->type;
        $firebase_notification->item_type_id = $req->id;
        $firebase_notification->receiver_id = $req->user_id;

        $firebase_notification->save();
    }
}
